<div class="humanfirst-body">
  <div class="hf-layout community-shell">
    <app-hf-sidebar
      [selectedDomain]="selectedDomain"
      [reloadToken]="sidebarReloadToken"
      (domainSelected)="onSidebarDomainSelected($event)">
    </app-hf-sidebar>

    <main class="community-main-col">
      <div class="community-main-feed">
        <p class="text-muted" *ngIf="loading">Loading community...</p>

        <section class="community-not-found" *ngIf="!loading && notFound">
          <h2>Community Not Found</h2>
          <p>The community you requested does not exist.</p>
          <button type="button" class="community-header-btn" (click)="goToCommunityDirectory()">Back to Communities</button>
        </section>

        <ng-container *ngIf="!loading && !notFound && community as currentCommunity">
          <section class="community-header-card">
            <div class="community-banner" [style.background-image]="getBannerBackground(currentCommunity)">
              <div class="community-avatar-large" [class.placeholder]="!currentCommunity.avatarImageUrl">
                <img *ngIf="currentCommunity.avatarImageUrl" [src]="currentCommunity.avatarImageUrl" [alt]="currentCommunity.name">
                <span *ngIf="!currentCommunity.avatarImageUrl">{{getCommunityAvatarLabel()}}</span>
              </div>
            </div>

            <div class="community-header-row">
              <div class="community-header-left">
                <div class="community-title-block">
                  <h1>{{currentCommunity.name}}</h1>
                  <p>{{getCommunityTagline()}}</p>
                </div>
              </div>

              <div class="community-header-actions">
                <button
                  type="button"
                  class="community-header-btn create"
                  [disabled]="deletingCommunity"
                  (click)="goToCreatePost()">
                  Create Post
                </button>

                <button
                  *ngIf="!communityDetail?.member"
                  type="button"
                  class="community-header-btn join"
                  [disabled]="joinInProgress || deletingCommunity"
                  (click)="joinCommunity()">
                  {{joinInProgress ? 'Joining...' : 'Join'}}
                </button>

                <button
                  *ngIf="communityDetail?.member && !communityDetail?.creator"
                  type="button"
                  class="community-header-btn joined"
                  [disabled]="joinInProgress || deletingCommunity"
                  (click)="leaveCommunity()">
                  {{joinInProgress ? 'Updating...' : 'Joined'}}
                </button>

                <span *ngIf="communityDetail?.creator" class="community-creator-pill">Creator</span>
              </div>
            </div>
          </section>

          <section class="community-feed-card">
            <h3>Community Posts</h3>

            <p class="text-muted" *ngIf="postsLoading">Loading posts...</p>
            <p class="text-muted" *ngIf="!postsLoading && posts.length === 0">No posts in this community yet.</p>

            <app-post-tile *ngIf="!postsLoading && posts.length > 0" [posts]="posts"></app-post-tile>
          </section>
        </ng-container>
      </div>
    </main>

    <aside class="community-info-col" *ngIf="!loading && !notFound && community as currentCommunity">
      <section class="community-info-card">
        <p class="community-info-label">Community</p>
        <h3>{{currentCommunity.name}}</h3>

        <p class="community-info-description">{{getDisplayedDescription()}}</p>
        <button
          *ngIf="shouldShowDescriptionToggle()"
          type="button"
          class="community-read-toggle"
          (click)="toggleDescription()">
          {{descriptionExpanded ? 'Read less' : 'Read more'}}
        </button>

        <div class="community-meta">
          <div class="community-meta-row">
            <span>Created</span>
            <strong>{{currentCommunity.createdAt ? (currentCommunity.createdAt | date:'mediumDate') : 'Unknown'}}</strong>
          </div>
        </div>

        <button type="button" class="community-guide-link" (click)="goToTopicArchive()">Community Guide</button>

        <div class="community-admin" *ngIf="communityDetail?.canEdit">
          <h4>Creator Controls</h4>

          <button
            type="button"
            class="community-admin-btn"
            [disabled]="deletingCommunity"
            (click)="toggleEditMode()">
            {{editMode ? 'Cancel Edit' : 'Edit Community'}}
          </button>

          <button
            type="button"
            class="community-admin-btn delete"
            [disabled]="deletingCommunity"
            (click)="deleteCommunity()">
            {{deletingCommunity ? 'Deleting...' : 'Delete Community'}}
          </button>
        </div>

        <div class="community-edit" *ngIf="editMode">
          <label for="community-description">Description</label>
          <textarea id="community-description" rows="4" [formControl]="editForm.controls.description"></textarea>

          <div class="community-media-block">
            <label>Avatar Headshot</label>
            <input
              #avatarImagePicker
              type="file"
              class="community-media-input"
              [accept]="acceptedCommunityImageTypes"
              (change)="onAvatarFileSelected($event)">
            <div
              class="community-media-dropzone"
              [class.drag-active]="isAvatarDragActive"
              [class.uploading]="isUploadingAvatar"
              role="button"
              tabindex="0"
              aria-label="Upload community avatar"
              (click)="onAvatarDropZoneClick(avatarImagePicker)"
              (keydown.enter)="onAvatarDropZoneClick(avatarImagePicker)"
              (keydown.space)="$event.preventDefault(); onAvatarDropZoneClick(avatarImagePicker)"
              (dragover)="onAvatarDragOver($event)"
              (dragleave)="onAvatarDragLeave($event)"
              (drop)="onAvatarDrop($event)">
              <strong>Upload avatar image</strong>
              <span>Drag-and-drop or click</span>
              <small>jpg, jpeg, png, webp, gif (max 8MB)</small>
            </div>
            <small *ngIf="isUploadingAvatar">Uploading avatar...</small>
            <div class="community-media-preview avatar" *ngIf="avatarPreviewUrl && !isUploadingAvatar">
              <img [src]="avatarPreviewUrl" alt="Avatar preview">
            </div>
            <small *ngIf="avatarUploadFileName">Selected avatar: {{avatarUploadFileName}}</small>
          </div>

          <div class="community-media-block">
            <label>Banner Background</label>
            <input
              #bannerImagePicker
              type="file"
              class="community-media-input"
              [accept]="acceptedCommunityImageTypes"
              (change)="onBannerFileSelected($event)">
            <div
              class="community-media-dropzone"
              [class.drag-active]="isBannerDragActive"
              [class.uploading]="isUploadingBanner"
              role="button"
              tabindex="0"
              aria-label="Upload community banner"
              (click)="onBannerDropZoneClick(bannerImagePicker)"
              (keydown.enter)="onBannerDropZoneClick(bannerImagePicker)"
              (keydown.space)="$event.preventDefault(); onBannerDropZoneClick(bannerImagePicker)"
              (dragover)="onBannerDragOver($event)"
              (dragleave)="onBannerDragLeave($event)"
              (drop)="onBannerDrop($event)">
              <strong>Upload banner image</strong>
              <span>Drag-and-drop or click</span>
              <small>jpg, jpeg, png, webp, gif (max 8MB)</small>
            </div>
            <small *ngIf="isUploadingBanner">Uploading banner...</small>
            <div class="community-media-preview banner" *ngIf="bannerPreviewUrl && !isUploadingBanner">
              <img [src]="bannerPreviewUrl" alt="Banner preview">
            </div>
            <small *ngIf="bannerUploadFileName">Selected banner: {{bannerUploadFileName}}</small>
          </div>

          <button
            type="button"
            class="community-admin-btn save"
            [disabled]="saveInProgress || deletingCommunity || isUploadingAvatar || isUploadingBanner"
            (click)="saveCommunityChanges()">
            {{saveInProgress ? 'Saving...' : 'Save Changes'}}
          </button>
        </div>
      </section>
    </aside>

    <div class="hf-right-gutter" aria-hidden="true"></div>
  </div>
</div>
