<app-hf-app-shell
  [selectedDomain]="selectedDomain"
  (domainSelected)="onSidebarDomainSelected($event)">
  <div shell-center>
    <div class="topic-page" *ngIf="!loading && topic; else topicStateTpl">
      <ng-container *ngIf="isMonthView(); else weekTopicTpl">
        <section class="topic-hero topic-hero-month">
          <p class="topic-kicker">Topic of the month</p>
          <h1 class="topic-title">{{topic.monthTitle}}</h1>
          <p class="topic-month">This month is divided into weekly focus topics for deeper discussion.</p>
          <button
            type="button"
            class="topic-btn topic-month-cta"
            [disabled]="!topic.slug"
            (click)="goToCurrentWeekTopic()">
            Go to current Topic of the Week
          </button>
        </section>

        <section class="topic-subdivisions topic-subdivisions-month">
          <h2>4 weekly topics this month</h2>
          <p class="topic-subdivisions-meta">Weekly tracks for this month:</p>

          <ul class="topic-subdivision-cards" *ngIf="topic.subdivisions?.length; else noSubdivisionsTpl">
            <li *ngFor="let subdivision of topic.subdivisions; trackBy: trackBySubdivision">
              <div class="topic-subdivision-card">{{subdivision.title}}</div>
            </li>
          </ul>
        </section>
      </ng-container>

      <ng-template #weekTopicTpl>
        <section class="topic-hero">
          <p class="topic-kicker">Topic of the week</p>
          <h1 class="topic-title">{{topic.weekTitle}}</h1>
        </section>

        <section class="topic-passage">
          <h2>About this week's topic</h2>
          <div class="topic-passage-scroll">
            {{getWeeklyTopicBody()}}
          </div>
        </section>

        <section class="topic-comments-section">
          <h3>Comments</h3>
          <p class="topic-column-meta">Top comments by upvotes, newest first when scores match.</p>

          <div class="topic-comment-editor">
            <p class="topic-comment-editor-label">Join the conversation</p>

            <div class="topic-stance-selector" role="radiogroup" aria-label="Select your stance">
              <button
                type="button"
                class="topic-stance-btn pro"
                [class.active]="selectedCommentStance === 'PRO'"
                [attr.aria-checked]="selectedCommentStance === 'PRO'"
                role="radio"
                (click)="setCommentStance('PRO')">
                Pro
              </button>
              <button
                type="button"
                class="topic-stance-btn con"
                [class.active]="selectedCommentStance === 'CON'"
                [attr.aria-checked]="selectedCommentStance === 'CON'"
                role="radio"
                (click)="setCommentStance('CON')">
                Con
              </button>
            </div>

            <textarea
              [value]="commentText"
              (input)="commentText = $any($event.target).value"
              placeholder="Add a comment"></textarea>
            <button type="button" class="topic-btn" (click)="submitTopLevelComment()">Post Comment</button>
          </div>

          <section class="topic-empty-state" *ngIf="unifiedComments.length === 0">
            <div class="topic-empty-icon" aria-hidden="true">...</div>
            <h4>Be the first to comment</h4>
            <p>Nobodyâ€™s responded to this topic yet. Add your thoughts and get the conversation going.</p>
          </section>

          <app-topic-comment-thread
            *ngIf="unifiedComments.length > 0"
            [topicId]="topic.id"
            [comments]="unifiedComments"
            [isLoggedIn]="isLoggedIn"
            (threadUpdated)="onThreadUpdated()">
          </app-topic-comment-thread>
        </section>
      </ng-template>
    </div>

    <ng-template #topicStateTpl>
      <div class="topic-state" *ngIf="loading">Loading topic discussion...</div>
      <div class="topic-state topic-state-error" *ngIf="!loading && errorMessage">{{errorMessage}}</div>
    </ng-template>
  </div>

  <div shell-right>
    <section class="topic-voting topic-voting-sticky" *ngIf="!loading && topic && !isMonthView()">
      <div class="vote-header">
        <h2>Pros vs Cons</h2>
        <span>{{topic.voteSummary.totalVotes}} total votes</span>
      </div>

      <div class="vote-bar" aria-label="Pros and cons vote percentages">
        <div class="pro-fill" [style.width.%]="getProBarPercent()"></div>
        <div class="con-fill" [style.width.%]="getConBarPercent()"></div>
      </div>

      <div class="vote-stats">
        <span>Pro: {{topic.voteSummary.proPercent}}% ({{topic.voteSummary.proVotes}})</span>
        <span>Con: {{topic.voteSummary.conPercent}}% ({{topic.voteSummary.conVotes}})</span>
      </div>

      <div class="vote-actions">
        <button
          type="button"
          class="topic-btn pro-btn"
          [class.active]="topic.voteSummary.userStance === 'PRO'"
          (click)="vote('PRO')">
          Take Pro Side
        </button>
        <button
          type="button"
          class="topic-btn con-btn"
          [class.active]="topic.voteSummary.userStance === 'CON'"
          (click)="vote('CON')">
          Take Con Side
        </button>
      </div>
    </section>
  </div>
</app-hf-app-shell>

<ng-template #noSubdivisionsTpl>
  <p class="topic-subdivisions-empty">Weekly topics will appear here once configured.</p>
</ng-template>
